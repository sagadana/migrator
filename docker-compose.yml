services:
  # ---------------------
  # Test
  # ---------------------
  tester-state:
    build:
      context: .
    working_dir: /usr/src/app
    volumes:
      - .:/usr/src/app
    command: go test -v -cover -coverpkg "github.com/sagadana/migrator/states" /usr/src/app/states
    networks:
      - dev-network
    env_file:
      - ./tests/.env.dev
    depends_on:
      redis:
        condition: service_healthy

  tester-ds:
    build:
      context: .
    working_dir: /usr/src/app
    volumes:
      - .:/usr/src/app
    command: go test -v -cover -coverpkg "github.com/sagadana/migrator/datasources" /usr/src/app/datasources
    networks:
      - dev-network
    env_file:
      - ./tests/.env.dev
    depends_on:
      redis:
        condition: service_healthy
      mongo-a:
        condition: service_healthy
      mongo-b:
        condition: service_healthy
      mongo-init:
        condition: service_completed_successfully
      postgres:
        condition: service_healthy
      mysql:
        condition: service_healthy
      mariadb:
        condition: service_healthy

  tester-pipe:
    build:
      context: .
    working_dir: /usr/src/app
    volumes:
      - .:/usr/src/app
    command: go test -v -cover -coverpkg "github.com/sagadana/migrator/pipelines" /usr/src/app/pipelines
    networks:
      - dev-network
    env_file:
      - ./tests/.env.dev
    environment:
      - TEST_DATASET_CSV_PATH=/usr/src/app/tests/datasets/sample-100.csv
    depends_on:
      redis:
        condition: service_healthy
      mongo-a:
        condition: service_healthy
      mongo-b:
        condition: service_healthy
      mongo-init:
        condition: service_completed_successfully
      postgres:
        condition: service_healthy
      mysql:
        condition: service_healthy
      mariadb:
        condition: service_healthy

  tester-helper:
    build:
      context: .
    working_dir: /usr/src/app
    volumes:
      - .:/usr/src/app
    command: go test -v -cover -coverpkg "github.com/sagadana/migrator/helpers" /usr/src/app/helpers
    networks:
      - dev-network
    env_file:
      - ./tests/.env.dev

  lint:
    image: golangci/golangci-lint:latest
    working_dir: /app
    volumes:
      - .:/app
    command: golangci-lint run
    networks:
      - dev-network
    env_file:
      - ./tests/.env.dev

  # ---------------------
  # Redis
  # ---------------------

  redis:
    image: 'redis:latest'
    restart: always
    expose:
      - ${REDIS_PORT}
    environment:
      - REDIS_REPLICATION_MODE=master
      - REDIS_PASSWORD=''
    networks:
      - dev-network
    healthcheck:
      test: redis-cli ping
      interval: 10s
      timeout: 5s
      retries: 3

  # -----------------------------------
  # MongoDB (replica set)
  # -----------------------------------

  # MongoDb Primary Replica
  mongo-a:
    image: 'mongo:latest'
    restart: always
    expose:
      - ${MONGO_PORT}
    environment:
      - MONGO_INITDB_ROOT_USERNAME=${MONGO_USER}
      - MONGO_INITDB_ROOT_PASSWORD=${MONGO_PASS}
      - MONGO_INITDB_DATABASE=${MONGO_DB}
      - MONGO_REPLICA_SET_NAME=${MONGO_RS}
    networks:
      - dev-network
    volumes:
      - ./tests/mongo/replica.key:/data/replica.key
    healthcheck:
      test: >
        mongosh --host localhost --quiet --eval  "try { rs.status().ok } catch (e) { 0 }"
      interval: 10s
      timeout: 5s
      retries: 3
    entrypoint:
      - bash
      - -c
      - |
        chmod 400 /data/replica.key
        chown 999 /data/replica.key
        exec docker-entrypoint.sh $$@
    command: mongod --bind_ip_all --replSet ${MONGO_RS} --keyFile /data/replica.key
  mongo-b:
    image: 'mongo:latest'
    restart: always
    expose:
      - ${MONGO_PORT}
    environment:
      - MONGO_INITDB_ROOT_USERNAME=${MONGO_USER}
      - MONGO_INITDB_ROOT_PASSWORD=${MONGO_PASS}
      - MONGO_INITDB_DATABASE=${MONGO_DB}
      - MONGO_REPLICA_SET_NAME=${MONGO_RS}
    networks:
      - dev-network
    volumes:
      - ./tests/mongo/replica.key:/data/replica.key
    healthcheck:
      test: >
        mongosh --host localhost --quiet --eval  "try { rs.status().ok } catch (e) { 0 }"
      interval: 10s
      timeout: 5s
      retries: 3
    entrypoint:
      - bash
      - -c
      - |
        chmod 400 /data/replica.key
        chown 999 /data/replica.key
        exec docker-entrypoint.sh $$@
    command: mongod --bind_ip_all --replSet ${MONGO_RS} --keyFile /data/replica.key
  # MongoDb Replica-Set Initializer
  mongo-init:
    image: 'mongo:latest'
    restart: 'no'
    depends_on:
      - mongo-a
      - mongo-b
    environment:
      - MONGO_INITDB_ROOT_USERNAME=${MONGO_USER}
      - MONGO_INITDB_ROOT_PASSWORD=${MONGO_PASS}
      - MONGO_HOST_1=${MONGO_PRIMARY_HOST}
      - MONGO_HOST_2=${MONGO_REPLICA_1}
      - MONGO_PORT=${MONGO_PORT}
      - MONGO_RS=${MONGO_RS}
    volumes:
      - ./tests/mongo/replica-init.sh:/scripts/replica-init.sh
    networks:
      - dev-network
    entrypoint:
      - bash
      - -c
      - |
        cat /scripts/replica-init.sh > /usr/bin/replica-init.sh
        sed -i 's/\r$//' /usr/bin/replica-init.sh # remove windows carriage-returns
        chmod +x /usr/bin/replica-init.sh
        exec /usr/bin/replica-init.sh $$@

  # ---------------------
  # PostgreSQL
  # ---------------------
  postgres:
    image: 'postgres:latest'
    restart: always
    expose:
      - ${POSTGRES_PORT}
    environment:
      - POSTGRES_USER=${POSTGRES_USER}
      - POSTGRES_PASSWORD=${POSTGRES_PASS}
      - POSTGRES_DB=${POSTGRES_DB}
    volumes:
      - ./tests/postgres/postgresql.conf:/etc/postgresql/postgresql.conf
    networks:
      - dev-network
    healthcheck:
      test: pg_isready -U ${POSTGRES_USER} -d ${POSTGRES_DB} -h localhost -p 5432
      interval: 10s
      timeout: 5s
      retries: 5
    command: postgres -c config_file=/etc/postgresql/postgresql.conf

  # ---------------------
  # MySQL
  # ---------------------
  mysql:
    image: 'mysql:latest'
    restart: always
    expose:
      - ${MYSQL_PORT}
    environment:
      - MYSQL_ROOT_PASSWORD=${MYSQL_ROOT_PASS}
      - MYSQL_DATABASE=${MYSQL_DB}
      - MYSQL_USER=${MYSQL_USER}
      - MYSQL_PASSWORD=${MYSQL_PASS}
    volumes:
      - ./tests/mysql/init.sql:/docker-entrypoint-initdb.d/init.sql
    networks:
      - dev-network
    healthcheck:
      test: mysqladmin ping -h localhost -u${MYSQL_USER} -p${MYSQL_PASS}
      interval: 10s
      timeout: 5s
      retries: 5
    command:
      # --binlog-format=ROW
      # --default-authentication-plugin=mysql_native_password
      --server-id=1 --log-bin=mysql-bin --binlog-do-db=${MYSQL_DB} --gtid-mode=ON --enforce-gtid-consistency=ON
      --log-replica-updates=ON

  # ---------------------
  # MariaDB
  # ---------------------
  mariadb:
    image: 'mariadb:latest'
    restart: always
    expose:
      - ${MARIADB_PORT}
    environment:
      - MYSQL_ROOT_PASSWORD=${MYSQL_ROOT_PASS}
      - MYSQL_DATABASE=${MYSQL_DB}
      - MYSQL_USER=${MYSQL_USER}
      - MYSQL_PASSWORD=${MYSQL_PASS}
    volumes:
      - ./tests/mysql/init.sql:/docker-entrypoint-initdb.d/init.sql
    networks:
      - dev-network
    healthcheck:
      test: mariadb-admin -h localhost -u${MYSQL_USER} -p${MYSQL_PASS} ping
      interval: 10s
      timeout: 5s
      retries: 5
    command: --binlog-format=ROW --server-id=1 --log-bin=mysql-bin --binlog-do-db=${MYSQL_DB}

networks:
  dev-network:
    driver: bridge
